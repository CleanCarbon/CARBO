# Дополнительная информация по смарт-контрактам CARBO

### Содежрание
* [Функциональные возможности CARBOToken](#carbotoken)
* [Функциональные возможности CrowdSale](#crowdsale)
* [Функциональные возможности VestingWallet](#vestingwallet)

## <a name="carbotoken"></a>Функциональные возможности CARBOToken
У контракта CARBO есть функционал, который позволяет `owner`у выводить с адреса контракта токены, и `BNB` отправленные на него по ошибке.  
Для этого следует воспользоваться методами `retrieveTokens` и `retrieveETH` соответственно.  
Метод `retrieveTokens` принимает два параметра: адрес, на который нужно отправить токены и адрес смарт-контракта токена.  
Методу `retrieveETH` нужен только один параметр: адрес, на который нужно отправить `BNB`.

## <a name="crowdsale"></a>Функциональные возможности CrowdSale
1. CrowdSale - это `pausable` контракт. В случае непредвиденных ситуаций покупку токенов можно приостановить.
2. Как и в случае с контрактом токена, у контракта CrowdSale предусмотрены методы для вывода токенов и `BNB`.
Вывод `BNB`, скорее всего, не потребуется (контракт принимает средства только во время действия распродажи).
С помощью метода `retreiveTokens` администратор может выводить с контракта другие токены, отправленные по ошибке.
### Этапы распродажи
В общем случае распродажа проводится в несколько этапов.
Этап описывается с помощью объекта:
```
struct Stage {
    uint256 start;
    uint256 end;
    uint256 bonus;
    uint256 minInvestmentLimit;
    uint256 invested;
    uint256 tokensSold;
    uint256 hardcapInTokens;
    uint8 vestingSchedule;
}
```
* `id` - идентификатор этапа
* `start` - дата начала этапа в формате `unixtime`
* `end` - дата окончания этапа в формате `unixtime`
* `bonus` - бонус в процентах от суммы покупки, который начисляется пользователю за приобретение токенов на данном этапе
* `minInvestmentLimit` - минимальная сумма покупки в `wei`
* `invested` - сумма привлеченных инвестиций на данном этапе в `wei`
* `tokensSold` - количество проданных токенов на данном этапе
* `hardcapInTokens` - хардкап для данного этапа
* `vestingSchedule` - `id` графика вестинга.

Каждый раз, когда пользователь отправляет `BNB` на адрес смарт-контракта, производится поиск активного этапа распродажи.
В случае, если подходящий этап не найден, пользователю возвращается ошибка.  
Контракт имеет метод `setStage` для изменения параметров этапов.  
С помощью этого метода `owner` может задавать основные параметры любого этапа.  
Общие правила взаимодействия со смарт-контрактом можно узнать в [инструкции для администратора](manager.md)  
> Мы рекомендуем использовать вкладку `config` в таблице `CARBO`, которая позволяет приобразовывать человекопонятные значения во внутреннее представление смарт-контракта.  
> На всякий случай перед тем как вносить изменения, проконсультируйтесь с разработчиком.

### Правила вестинга
К любому из этапов распродажи можно применить правила вестинга.
На момент написания этого документа распродажа проводится в один этап, который использует график вестинга с id `0`.
Вестинг подразумевает, что токены, приобретенные во время соответствующего этапа распродажи, не переводятся на адрес покупателя, а отправляются на адрес контракта вестинга.  
Для того чтобы вывести токены, пользователю нужно будет вызвать метод `withdraw` контракта вестинга.
* В случае, если условия вестинга соблюдены и к выводу доступны токены, контракт переведет расчетную сумму на адрес пользователя.
* В случае, если на балансе пользователя нет токенов, доступных к выводу, смарт-контракт вернет ошибку.

Пользователь может сэкономить свои средства и не выполнять транзакцию, т.к. Metamask заранее распознает транзакции, которые возвращают ошибки, и выводит уведомление перед отправкой.  
Параметры вестинга описываются с помощью объекта `VestingSchedule`


## <a name="vestingwallet"></a>Функциональные возможности VestingWallet
### Права доступа
Контракт `VestingWallet` работает с двумя группами пользователей:
* `owner`. Данный пользователь может производить конфигурацию контракта и вызывать служебные методы для вывода токенов и средств, отправленных на него по ошибке.
* `beneficiary`. Данный пользователь является конечным пользователем данного контракта и имеет право выводить с него токены в соответствии с графиком вестинга.
### Графики выплат
Контракт хранит список графиков выплат. Каждый график выплаты описывается с помощью объекта `VestingSchedule`:
```
VestingSchedule {
    uint256 id;
    uint256 start;
    uint256 duration;
    uint256 interval;
}
```
* `id` - идентификатор графика. Балансы пользователя используют этот идентификатор для того, чтобы получать информацию о следующей выплате
* `start` - дата, с которой начинается отсчет, в формате `unixtime`
* `duration` - суммарная продолжительность рассроченной выплаты в секундах
* `interval` - длительность временного промежутка между выплатами в секундах

Для установки параметров вестинга `owner`у следует использовать метод `setVestingSchedule`.

### Балансы пользователей
Контракт хранит список пользовательских балансов. Баланс описывается с помощью объекта `Balance`:
```
struct Balance {
    uint256 schedule;
    address beneficiary;
    uint256 initial;
    uint256 withdrawn;
}
```
* `schedule` - `id` графика выплат. Соответствует `id` объекта `VestingSchedule`
* `beneficiary` - адрес пользователя
* `initial` - изначальное количество токенов на балансе
* `withdrawn` - сумма выведенных токенов

Для получения информации о состоянии аккаунта, нужно воспользоваться методом `getAccountInfo`.
Метод принимает адрес пользователя в качестве параметра и возвращает три значения:
* `initial` - изначальное количество токенов, замороженных на смарт-контракте
* `withdrawn` - количество извлеченных токенов
* `vested` - количество токенов, доступных для извлечения
